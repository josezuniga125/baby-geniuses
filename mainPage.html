<!--Main Page PiggyBank-->
<!DOCTYPE html>
<html>


<head>
<meta charset="utf-8">
<title>PiggyBank</title>

<!-- Load style sheets -->
<link rel="stylesheet" href=
  "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css">

<link rel="stylesheet" href="mainPage.css">

<script src="wishlist.js"></script>

<!-- Move to another part? -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script>

// A short jQuery extension to read query parameters from the URL.
$.extend({
  getUrlVars: function() {
    var vars = [], pair;
    var pairs = window.location.search.substr(1).split('&');
    for (var i = 0; i < pairs.length; i++) {
      pair = pairs[i].split('=');
      vars.push(pair[0]);
      vars[pair[0]] = pair[1] &&
          decodeURIComponent(pair[1].replace(/\+/g, ' '));
    }
    return vars;
  },
  getUrlVar: function(name) {
    return $.getUrlVars()[name];
  }
});


var previousTotal = 0.0;
var total = 0.0;

if ($.getUrlVar('total') != undefined) {
  total = parseFloat($.getUrlVar('total'));
  setCookie("total_cookie",total);
}

var runningTotal = 0.0;
var historyID = 0;

var dragged;

/* Cookies */
function setCookie(cname,cvalue) {
    document.cookie = cname + "=" + cvalue;
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function checkCookieTotal() {
    var total_cookie =getCookie("total_cookie");
    if (total_cookie != "") {
        total = parseFloat(total_cookie);
        document.getElementById('total').innerHTML = "Total: $" + total.toFixed(2);        
    } else {
       setCookie("total_cookie", 0.0);
    }
}


/* events fired on the draggable target */
document.addEventListener("drag", function( event ) {
}, false);

document.addEventListener("dragstart", function( event ) {
    // store a ref. on the dragged elem
    dragged = event.target;
    clone = event.target.cloneNode(true);
    // make it half transparent
    event.target.style.opacity = .5;

}, false);

document.addEventListener("dragend", function( event ) {
    // reset the transparency
    event.target.style.opacity = "";
}, false);

/* events fired on the drop targets */
document.addEventListener("dragover", function( event ) {
    // prevent default to allow drop
    event.preventDefault();
}, false);

document.addEventListener("dragenter", function( event ) {
    // highlight potential drop target when the draggable element enters it
    if ( event.target.className == "dropzone" ) {
        event.target.style.background = "lightgrey";
    }

}, false);

document.addEventListener("dragleave", function( event ) {
    // reset background of potential drop target when the draggable element leaves it
    if ( event.target.className == "dropzone" ) {
        event.target.style.background = "";
    }
}, false);

document.addEventListener("drop", function( event ) {
    // prevent default action (open as link for some elements)
    event.preventDefault();
    // move dragged elem to the selected drop target
    if ( event.target.className == "dropzone" ) {
        event.target.style.background = "";

        var element = document.getElementById("dragged-money");
        element.appendChild(clone);


        //event.target.appendChild(clone);

        var id = event.dataTransfer.getData("Text");

        if (clone.id == "one-dollar") {
          runningTotal += 1;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '140px');

        } else if (clone.id == "five-dollar") {
          runningTotal += 5;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '140px');
        } else if (clone.id == "ten-dollar") {
          runningTotal += 10;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '140px');
        } else if (clone.id == "twenty-dollar") {
          runningTotal += 20;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '140px');
        } else if (clone.id == "penny") {
          runningTotal += 0.01;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '41px');
        } else if (clone.id == "nickel") {
          runningTotal += 0.05;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '45px');
        } else if (clone.id == "dime") {
          runningTotal += 0.1;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '40px');
        } else if (clone.id == "quarter") {
          runningTotal += 0.25;
          document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);
          clone.setAttribute('width', '50px');
        }


    }
}, false);


$(document).on('click', "#undo-btn", function(evt)
{
  total=previousTotal;
  previousTotal=0;
  document.getElementById('total').innerHTML = "Total: $" + total.toFixed(2);
  document.getElementById("undo-btn").disabled = true;

  // Update history
  var ID = "#item_" + historyID;
  $(ID).remove();

});

$(document).on('click', "#save-btn", function(evt)
{
  if (runningTotal > 0) {
    // Update total
    amount = runningTotal;
    previousTotal=total;
    total+=amount;
    document.getElementById('total').innerHTML = "Total: $" + total.toFixed(2);
    document.getElementById("undo-btn").disabled = false;

    setCookie("total_cookie", total);

    // Fix URL
    var currentURL = window.location.href;
    var total_index = currentURL.indexOf("total");
    var url_total =  currentURL.substring(0,total_index) + "total=" + total;
    var stateObj = { foo: "" };
    history.pushState(stateObj, "", url_total);

    runningTotal = 0;
    document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);

    // Add item to history
    historyID += 1;
    var inputText = $("#notes");
    var notes = $(inputText).val();

    var history_item = "<div class='history-item' id='item_" + historyID + "' style='color: green'><div class='history-text'> + $" + amount.toFixed(2) + " " + notes + "</div><button class='btn btn-default btn-sm undo-history-btn' id='" + historyID + "' type='button'>X</button></div>";
    $('#history-items').prepend(history_item);

    $("#notes").val("");
    $("#dragged-money").remove();
    $(".dropzone").append("<div class='dragged-money' id='dragged-money'></div>");
  }
  
});

$(document).on('click', "#spend-btn", function(evt)
{
  if (runningTotal > 0) {
    // Update total
    amount = runningTotal;
    previousTotal=total;
    total-=amount;
    document.getElementById('total').innerHTML = "Total: $" + total.toFixed(2);
    document.getElementById("undo-btn").disabled = false;

    setCookie("total_cookie", total);

    // Fix URL
    var currentURL = window.location.href;
    var total_index = currentURL.indexOf("total");
    var url_total =  currentURL.substring(0,total_index) + "total=" + total;
    var stateObj = { foo: "" };
    history.pushState(stateObj, "", url_total);

    runningTotal = 0;
    document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);

     // Add item to history
    historyID += 1;
    var inputText = $("#notes");
    var notes = $(inputText).val();

    var history_item = "<div class='history-item' id='item_" + historyID + "' style='color: red'><div class='history-text'> - $" + amount + " " + notes + "</div><button class='btn btn-default btn-sm undo-history-btn' id='" + historyID + "' type='button'>X</button></div>";
    $('#history-items').prepend(history_item);
      
    $("#notes").val("");
    $("#dragged-money").remove();
    $(".dropzone").append("<div class='dragged-money' id='dragged-money'></div>");
  }

});

$(document).on('click', "#clear-btn", function(evt)
{
  $("#dropzone").remove(".coins");
  console.log("clear pressed");

  runningTotal = 0;
  document.getElementById('running-total').innerHTML = "$" + runningTotal.toFixed(2);

  $("#dragged-money").remove();
  $(".dropzone").append("<div class='dragged-money' id='dragged-money'></div>");

});

$(document).on('click', "#clear-all-history", function(evt)
{
  $("#history-items").remove();
  $("#lastColumn").append("<div id='history-items'></div>");

});

$(document).on('click', ".undo-history-btn", function(evt)
{
  var ID = "#item_" + this.id;
  $(ID).remove();
});

</script>


</head>

<body>

<br>
<div class="container">
  <div class="row">
    <div class="col-md-4" id="firstColumn">
      <div>
      
      <!-- Money Table-->
      <table class="table">
      <tr class="dollars">
        <td draggable="true"><img id="one-dollar" src="One.jpg" alt="One Dollar Bill" style="object-fit: contain" height="auto" width="100%"></td>
        <td draggable="true"><img id="five-dollar" src="Five.jpg" alt="Five Dollar Bill" style="object-fit: contain" height="auto" width="100%"></td>
      </tr>
      <tr class="dollars">
        <td draggable="true"><img id="ten-dollar" src="Ten.jpg" alt="Ten Dollar Bill" style="object-fit: contain" height="auto" width="100%"></td>
        <td draggable="true"><img id="twenty-dollar" src="Twenty.jpg" alt="Twenty Dollar Bill" style="object-fit: contain" height="auto" width="100%"></td>
      </tr>
      </table>
      <table class="table">
      <tr class="coins">
        <td draggable="true"><img id="penny" src="Penny.png" alt="Penny" style="object-fit: contain" height="auto" width="75%"></td>
        <td draggable="true"><img id="nickel" src="Nickel.png" alt="Nickel" style="object-fit: contain" height="auto" width="85%"></td>
        <td draggable="true"><img id="dime" src="Dime.png" alt="Dime" style="object-fit: contain" height="auto" width="70%"></td>
        <td draggable="true"><img id="quarter" src="Quarter.png" alt="Quarter" style="object-fit: contain" height="auto" width="100%"></td>
      </tr>
      </table>

      <!-- Clickable box -->
      <div class="amount-title text-center">Amount:</div>
      <div class="dropzone">
        <div class="running-total" id="running-total">$<script type="text/javascript">document.write(runningTotal.toFixed(2));</script></div>
        <button class="btn btn-default btn-sm" id="clear-btn" type="button">Clear</button>
        <div class='dragged-money' id='dragged-money'></div>
      </div>

      <br>
      <!-- Notes -->
      <form>
        <div class="row">
          <label id="notes-label">Notes:</label>
          <input type="text" class="form-control" id="notes" placeholder="Allowance">
        </div>
      </form>

      <br>
      <!-- Buttons below -->
      <div class="text-center">
        <button type="button" class="btn btn-success btn-lg btn-save-spend" id="save-btn" >Save</button>
        <button type="button" class="btn btn-danger btn-lg btn-save-spend" id="spend-btn" >Spend</button>
      </div>

      </div>
  </div>

    <div class="col-md-4" id="mainColumn">

      <!-- Column 2 Code Here -->
      <img id="thought-cloud" src="ThoughtCloud.png" alt="Thought Cloud" onclick="window.location.href='wishlist.html'">
      <div class="thought-text text-center" onclick="window.location.href='wishlist.html?total=' + total.toFixed(2)">Wishlist</div>

      <img id="piggy-image" src="piggy.jpg" alt="Piggy Bank" style="height: auto; width: 100%; object-fit: contain" onclick="window.location.href='wishlist.html?total=' + total.toFixed(2)">

      <div class="text-center">
        <div class="total-title" id="total">Total: $<script type="text/javascript">document.write(total.toFixed(2));</script></div>
        <button type="button" class="btn btn-default btn-lg" id="undo-btn">Undo</button>
      </div>

    </div>

    <div class="col-md-4" id="lastColumn">

      <!-- Column 3 Code Here -->
      <div class="history-title text-center">History
      <button type="button" class="btn btn-sm" id="clear-all-history">Clear All</button>
      </div>
      <div id="history-items">

      </div>

    </div>
  </div> <!-- class="row" -->
</div> <!-- class="container" -->


</body>


</html>

<script>
if ($.getUrlVar('total') == undefined)
{
  checkCookieTotal();
}

</script>

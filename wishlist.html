<!-- Cited sources:

For implementing pop-up modal boxes when purchasing items / adding items:
- https://www.w3schools.com/howto/howto_css_modals.asp

For implementing drag-and-drop for wishlist items and money assets:
- https://developer.mozilla.org/en-US/docs/Web/Events/drop

-->

<!doctype html>

<html>
<head>
    <!-- Load style sheets -->
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css">
    <link rel="stylesheet" href="wishlist.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
   
    <script src="wishlist.js"></script>

    <script>

      // A short jQuery extension to read query parameters from the URL.
      $.extend({
        getUrlVars: function() {
          var vars = [], pair;
          var pairs = window.location.search.substr(1).split('&');
          for (var i = 0; i < pairs.length; i++) {
            pair = pairs[i].split('=');
            vars.push(pair[0]);
            vars[pair[0]] = pair[1] &&
                decodeURIComponent(pair[1].replace(/\+/g, ' '));
          }
          return vars;
        },
        getUrlVar: function(name) {
          return $.getUrlVars()[name];
        }
      });

      var total = parseFloat($.getUrlVar('total'));

    </script>


</head>

<body>

<div class="container">
  <div class="row">

    <div class="col-md-2" id="firstColumn">
       <img draggable="false" id="wishListPiggy" src="piggy.jpg" onclick="window.location.href='mainPage.html?total=' + total.toFixed(2)">
       <img draggable="false" class = "dropZone" id="trashCan" src="trashcan.png" style="height: auto; width: 100%; object-fit: contain">

       <!-- Trashcan modal -->
       <div id="myTrashModal" class="modal">
       <!-- Trashcan modal content -->
        <div class="modal-content">
          <div class="modal-header">
            <span class="trashClose">&times;</span>
              <h2>This item costs $5. You currently have X. Do you want to buy or trash this item?</h2>
          </div>
          <div class="trashModal-body">
            <button type="button" class = "btn btn-default" id = "yesButton" onclick="deductFromTotal()">Yes </button>
            <button type="button" class = "btn btn-default" id = "noButton" onclick="hideTrashModal()">No </button>
          </div>
       
        </div>
      </div>

    </div>

    <div class="col-md-8" id="mainColumn">

      <div class="container" id="wishlistContainer">
          <span class="pricetag" id="bballTag">basketball $5</span> 
          <img draggable="true" id="basketball" src="wishlist-icons/basketball.png">
          <span class="pricetag" id="teddyBearTag">teddy bear $5</span>
          <img draggable="true" id="teddyBear" src="wishlist-icons/teddy-bear.png">
          <span class="pricetag" id="rollerSkatesTag">roller skates $5</span>
          <img draggable="true" id="rollerSkates" src="wishlist-icons/skates.png">
          <img draggable="false" id="wishListThoughtBubble" src = "wishListThoughtBubble.jpg">
      </div>

      <div class="totalAmount" id="total">Total: $ <script type="text/javascript">document.write(total.toFixed(2));</script></div>

    </div>

    <div class="col-md-2" id="lastColumn">
      <img draggable="false" id="wishListPlusSign" src = "plusSign.gif" style="height: auto; width: 100%; object-fit: contain">

      <!-- Drop down box for adding item -->
      <div id="add-modal" class="modal">
      <!-- Add modal content -->
        <div class="add-modal-content">
          <div class="add-modal-header">
            <span id="add-modal-close" class="close">&times;</span>
            <h2 id="add-modal-title"> Add Item to Wishlist </h2>
          </div>
          <div class="add-modal-body">
            
            <table id="add-modal-body-detail">
              <tr id="add-modal-name">
                  <td class="add-modal-detail-name"> Item: </td>
                  <td class="add-modal-detail-input"><input id="add-modal-name-input" type="text" placeholder="Name"></td>
              </tr>
              <tr id="add-modal-amount">
                  <td class="add-modal-detail-name"> Amount: </td>
                  <td class="add-modal-detail-input"><input id="add-modal-amount-input" type="text" placeholder="$0.00"></td>
              </tr>
              <tr id="add-modal-icon-text">
                  <td class="add-modal-detail-name"> Icon: </td>
                  <td class="add-modal-detail-input"><input type="file" id="add-modal-icon-loader" name="image-loader"></td>
              </tr>
              <tr>
                  <td></td>
                  <td><canvas class="add-modal-detail-input" id="image-canvas" width="300px" height="300"></canvas></td>
              </tr>
            </table>
           
          </div>

          <div class="add-modal-footer">
            <button type="button" class="btn btn-default" id="add-modal-confirm-button"> Confirm </button>
          </div>

        </div>
      </div>

    </div>


</body>


    <script>

        //added for coloring of price tags (green when able to buy and gray otherwise)
        var priceTags = document.getElementsByClassName("pricetag");
        for (tag = 0; tag < priceTags.length; tag ++){
          if (total.toFixed(2) >= 5){ // for now 5, but will be replaced by specific price on tag
            priceTags[tag].style.background = "lightgreen";
          }
          else{
            priceTags[tag].style.background = "#E8EDF0";
          }
        }

        //Code for dragging items to the trashcan
        var dragged;

        /* initialize the total */
        $(document).ready(function()
        {
          document.getElementById('total').innerHTML = "Total: $" + total.toFixed(2);
        });

        /* events fired on the draggable target */
        document.addEventListener("drag", function( event ) {
          event.dataTransfer.setData("text", event.currentTarget.id);
          //console.log(event.currentTarget.id);
          //console.log("in drag");
        }, false);

        document.addEventListener("dragstart", function( event ) {
            // store a ref. on the dragged elem
            dragged = event.target;
            clone = event.target.cloneNode(true);
            // make it half transparent
            event.target.style.opacity = 0;
        }, false);

        document.addEventListener("dragend", function( event ) {
            // reset the transparency
            event.target.style.opacity = "";
        }, false);

        /* events fired on the drop targets */
        document.addEventListener("dragover", function( event ) {
            // prevent default to allow drop
            event.preventDefault();
        }, false);

        document.addEventListener("dragenter", function( event ) {
            // highlight potential drop target when the draggable element enters it
            if ( event.target.className == "dropZone" ) {
                //event.target.style.background = "lightgrey";
            }

        }, false);

        document.addEventListener("dragleave", function( event ) {
            // reset background of potential drop target when the draggable element leaves it
            if ( event.target.className == "dropZone" ) {
                event.target.style.background = "";
            }
        }, false);

        document.addEventListener("drop", function( event ) {
            // prevent default action (open as link for some elements)
            event.preventDefault();
            // move dragged elem to the selected drop target
            if (event.target.className == "dropZone" ) {
              event.target.style.background = "";
              dragged.parentNode.removeChild( dragged );
                
              trashModal.style.display = "block";

              trashSpan.onclick = function() {
                trashModal.style.display = "none";
              }

              window.onclick = function(event) {
                if (event.target == trashModal) {
                trashModal.style.display = "none";
                }
              }

              // TODO: this has no functionality:
              trashNoButton.onclick = function() {
                trashModal.style.display = "none";
              }

            }

        }, false);

        /* TrashCan Modal */

        // Get the modal:
        var trashModal = document.getElementById('myTrashModal');

        // Get the <span> element that closes the modal:
        var trashSpan = document.getElementsByClassName("trashClose")[0];

        var trashNoButton = document.getElementById("noButton");
        var trashYesButton = document.getElementById("yesButton");

        function hideTrashModal() {
          trashModal.style.display = "none";
        }

        function deductFromTotal() {
          trashModal.style.display = "none";
          if ((total - 5.0) > 0) {
            total = total - 5.0;
          }
          document.getElementById('total').innerHTML = "Total: $" + total.toFixed(2);

          // Fix URL
          var currentURL = window.location.href;
          var total_index = currentURL.indexOf("total");
          var url_total =  currentURL.substring(0,total_index) + "total=" + total;
          var stateObj = { foo: "" };
          history.pushState(stateObj, "", url_total);
        }

        /* Add Modal */

        // Get the modal:
        var modal = document.getElementById('add-modal');

        // Get the button that opens the modal:
        var btn = document.getElementById("wishListPlusSign");

        // Get the <span> element that closes the modal:
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal:
        btn.onclick = function() {
            modal.style.display = "block";
            $('#add-modal-name-input').focus();
        }

        // When the user clicks on <span> (x), close the modal:
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it:
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        /* Add Modal Image Loader */

        var imageCanvas = document.getElementById('image-canvas');
        var context = imageCanvas.getContext('2d');

        function handleImage(e) {
          var reader = new FileReader();
          reader.onload = function(event) {
            var image = new Image();
            image.onload = function() {
              context.drawImage(image, 0, 0);
            }
            image.src = event.target.result;
          }
          reader.readAsDataURL(e.target.files[0]);
        }

        var imageLoader = document.getElementById('add-modal-icon-loader');
        imageLoader.addEventListener('change', handleImage, false);
        
    </script>

</html>
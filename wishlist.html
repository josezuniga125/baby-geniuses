<!-- Cited sources:

For implementing pop-up modal boxes when purchasing items / adding items:
- https://www.w3schools.com/howto/howto_css_modals.asp

For implementing drag-and-drop for wishlist items and money assets:
- https://developer.mozilla.org/en-US/docs/Web/Events/drop

For implementing the popup:
- https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_popup

For implementing isNumeric:
- http://stackoverflow.com/questions/9716468/is-there-any-function-like-isnumeric-in-javascript-to-validate-numbers
-->


<!doctype html>

<html>
<head>
    <!-- Load style sheets -->
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css">
    <link rel="stylesheet" href="wishlist.css">
    
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="emoji-picker/lib/css/emoji.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
   
    <script src="wishlist.js"></script>
    <script src="emoji-picker/lib/js/config.js"></script>
    <script src="emoji-picker/lib/js/util.js"></script>
    <script src="emoji-picker/lib/js/jquery.emojiarea.js"></script>
    <script src="emoji-picker/lib/js/emoji-picker.js"></script>

    <script>

      // A short jQuery extension to read query parameters from the URL.
      $.extend({
        getUrlVars: function() {
          var vars = [], pair;
          var pairs = window.location.search.substr(1).split('&');
          for (var i = 0; i < pairs.length; i++) {
            pair = pairs[i].split('=');
            vars.push(pair[0]);
            vars[pair[0]] = pair[1] &&
                decodeURIComponent(pair[1].replace(/\+/g, ' '));
          }
          return vars;
        },
        getUrlVar: function(name) {
          return $.getUrlVars()[name];
        }
      });

      var total = parseFloat($.getUrlVar('total'));

    </script>


</head>

<body>

<div class="container">
  <div class="row">

    <div class="col-md-2" id="firstColumn" onclick="hideSelectMenu()">
       <img draggable="false" id="wishListPiggy" src="piggy.jpg" onclick="window.location.href='mainPage.html?total=' + total.toFixed(2)">
       <!-- <img draggable="false" class = "dropZone" id="trashCan" src="trashcan.png" style="height: auto; width: 100%; object-fit: contain"> -->

       <!-- Trashcan modal -->
       <!-- <div id="myTrashModal" class="modal"> -->
       <!-- Trashcan modal content -->
        <!-- <div class="modal-content">
          <div class="modal-header">
            <span class="trashClose">&times;</span>
              <h2>This item costs $5. You currently have . Do you want to buy or trash this item?</h2>
          </div>
          <div class="trashModal-body">
            <button type="button" class = "btn btn-default" id = "yesButton" onclick="deductFromTotal()">Yes </button>
            <button type="button" class = "btn btn-default" id = "noButton" onclick="hideTrashModal()">No </button>
          </div>
       
        </div>
      </div> -->

    </div>

    <div class="col-md-8" id="mainColumn">

      <div class="container" id="wishlistContainer">
          <!-- <span class="pricetag" id="bballTag">basketball $5</span> 
          <img draggable="true" id="basketball" src="wishlist-icons/animated-bball.png">
          <span class="pricetag" id="teddyBearTag">teddy bear $5</span>
          <img draggable="true" id="teddyBear" src="wishlist-icons/animated-teddy.png">
          <span class="pricetag" id="rollerSkatesTag">roller skates $5</span>
          <img draggable="true" id="rollerSkates" src="wishlist-icons/animated-skates.png"> -->
          <img draggable="false" id="wishListThoughtBubble" src="thought-cloud-2.png" onclick="hideSelectMenu()">
          <table id="select-menu-detail">
            <tr id="select-menu-name">
              <td class="select-menu-detail-name">
                <span id="select-menu-close" onclick="hideSelectMenu()">&times;</span>
                <span>Item</span>
              </td>
            </tr>
            <tr id="select-menu-purchase">
              <td class="select-menu-detail-button">
                <input class="btn btn-default" type="button" value="Purchase" id="select-menu-purchase-button">
              </td>
            </tr>
            <tr id="select-menu-edit">
              <td class="select-menu-detail-button">
                <input class="btn btn-default" type="button" value="Edit" id="select-menu-edit-button">
              </td>
            </tr>
            <tr id="select-menu-remove">
              <td class="select-menu-detail-button">
                <input class="btn btn-default" type="button" value="Remove" id="select-menu-remove-button">
              </td>
            </tr>
          </table>
      </div>

      <div class="totalAmount" id="total">Total: $ <script type="text/javascript">document.write(total.toFixed(2));</script></div>

    </div>

    <div class="col-md-2" id="lastColumn" onclick="hideSelectMenu()">
      <img draggable="false" id="wishListPlusSign" src = "plusSign.gif">

      <!-- Drop down box for adding item -->
      <div id="add-modal" class="modal">
      <!-- Add modal content -->
        <div class="add-modal-content">
          <div class="add-modal-header">
            <span id="add-modal-close" class="close">&times;</span>
            <h2 id="add-modal-title"> Add Item to Wishlist </h2>
          </div>
          <div class="add-modal-body">
            
            <table id="add-modal-body-detail">
              <tr id="add-modal-name">
                  <td class="add-modal-detail-name"> Item: </td>
                  <td class="add-modal-detail-input">
                    <input type="text" id="add-modal-name-input" placeholder="Name" onkeyup="checkValidAddInputs()">
                  </td>
              </tr>
              <tr id="add-modal-amount">
                  <td class="add-modal-detail-name"> Amount: </td>
                  <td class="add-modal-detail-input">
                    <input type="text" id="add-modal-amount-input" placeholder="$0.00" onkeyup="checkValidAddInputs()">
                  </td>
              </tr>
              <tr id="add-modal-icon-text">
                  <td class="add-modal-detail-name"> Upload icon: </td>
                  <td class="add-modal-detail-input">
                    <input type="file" id="add-modal-icon-loader" name="image-loader">
                  </td>
              </tr>
              <tr>
                  <td></td>
                  <td><canvas class="add-modal-detail-input" id="image-canvas" width="300px" height="300"></canvas></td>
              </tr>
            </table>
          </div>

          <div class="add-modal-footer">
            <button type="button" class="btn btn-default" id="add-modal-confirm-button" onclick="confirmButton()" disabled="true"> Confirm </button>
          </div>

        </div>

        <div id="capacity-modal" class="modal">
      <!-- Add modal content -->
        <div class="add-modal-content">
          <div class="add-modal-header">
            <span id="capacity-modal-close" class="close">&times;</span>
            <h2 id="capacity-modal-title"> You have reached wishlist capacity! </h2>
          </div>
          <div class="add-modal-body"> Please delete an existing item in order to add a new one!</div>

          <div class="add-modal-footer">
            <button type="button" class="btn btn-default" id="add-modal-confirm-button" onclick="confirmButton()"> Confirm </button>
          </div>

        </div>
      </div>

    </div>


</body>


    <script>

        /* Constants */
        
        var ITEM_CAPACITY = 9;
        var POSITIONS = [[300,200], [100,400], [500,400], [300,400], [100,200], [100,300], [300,300], [500,200], [500,300],[300,300]];
        var ITEM_SIZE = 100

        /* Globals */

        var isOpen = [true, true, true, true, true, true, true, true, true];
        var open_position = 0;
        var positionX;
        var positionY;

        //added for coloring of price tags (green when able to buy and gray otherwise)
        var priceTags = document.getElementsByClassName("pricetag");
        //var priceTagsBefore = document.getElementsByClassName("pricetag:before");
        for (tag = 0; tag < priceTags.length; tag ++){
          if (total.toFixed(2) >= 5){ // for now 5, but will be replaced by specific price on tag
            priceTags[tag].style.background = "#6AE368";
            priceTags[tag].style.color = "white";
            
          }
          else{
            priceTags[tag].style.background = "#E8EDF0";
            priceTags[tag].style.color = "black";
          }
        }

        function deductFromTotal(value) {
          console.log("Total: " + total);
          console.log("Value: " + value);
          total -= value;
          document.getElementById('total').innerHTML = "Total: $ " + total.toFixed(2);

          console.log("After: " + total.toFixed(2));

          // Fix URL
          var currentURL = window.location.href;
          var total_index = currentURL.indexOf("total");
          var url_total = currentURL.substring(0, total_index) + "total=" + total;
          var stateObj = { foo: "" };
          history.pushState(stateObj, "", url_total);
        }

        /* Add Modal */

        // Get the modal:
        var modal = document.getElementById('add-modal');

        var capacity_modal = document.getElementById('capacity-modal');

        // Get the button that opens the modal:
        var btn = document.getElementById("wishListPlusSign");

        // Get the <span> element that closes the modal:
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal:
        btn.onclick = function() {

          // Linear search to find an open position:
          for(pos = 0; pos < ITEM_CAPACITY; pos++) {
            if (isOpen[pos]) {
              open_position = pos;
              modal.style.display = "block";
              $('#add-modal-name-input').focus();
              return;
            }
          }
          // reached the end of the search, no open spots:
          alert("You have reached the wishlist capacity of 9 items! Please delete an item in order to add.");
        }

        // When the user clicks on <span> (x), close the modal:
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it:
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        /* Add Modal Image Loader */

        var imageCanvas = document.getElementById('image-canvas');
        var context = imageCanvas.getContext('2d');
        var image;
        var selectedImage;

        function handleImage(e) {
          var reader = new FileReader();
          reader.onload = function(event) {
            image = new Image();
            image.className = "wishListItem"; // I gave the images a class, just in case
            image.onload = function() {
              context.drawImage(image, 0, 0, 50, 50);
            }
            image.src = event.target.result;
          }
          reader.readAsDataURL(e.target.files[0]);
        }

        //this is just for the listener down below, when you click on the image canvas. Might not be necessary.
        function clickIcon() {
          selectedImage = image;
        }

        // Functionality for Confirm Button:
        function confirmButton() {

          // Get input from Name and Amount boxes for price tags:
          var nameInput = $("#add-modal-name-input").val();
          var amountInput = $("#add-modal-amount-input").val();

          var parentOffset = $('#wishlistContainer').offset();

          positionX = POSITIONS[open_position][0];
          positionY = POSITIONS[open_position][1];
          var tagX = positionX + 75;
          var tagY = positionY;

          isOpen[open_position] = false;

          // Add item to wishlist bubble:
          $('#wishlistContainer').append('<img src=" ' + image.src + ' "class="popup" id="image' + open_position + '"style="width:' + 10 + '%; height:auto; position:absolute; ' + 'left:' + positionX + 'px; top:' + positionY + 'px"/>');

          // Add price tag to item in wishlist bubble:
          $('#wishlistContainer').append('<span class="pricetag" id="giftTag' + open_position + '"style ="left:' + tagX + 'px; top:' + tagY + 'px; background: #E8EDF0">'+ nameInput +' $' + amountInput + '</span>');

          var item_pos = open_position;

          // Get the item element:
          var item = document.getElementById('image' + item_pos);

          // Get the price tag for that item:
          var priceTag = document.getElementById('giftTag' + item_pos);

          item.addEventListener('click', function() {
            // Animate select menu:
            hideSelectMenu();
            $('#select-menu-detail').css({left: item.offsetLeft - 120, top: item.offsetTop});
            $('#select-menu-detail').fadeIn(250);

            // Disable purchase button if user can't afford it:
            if (parseFloat(amountInput) > total.toFixed(2)) {
              $('#select-menu-purchase-button').prop('disabled', true);
              $('#select-menu-purchase-button').css('cursor', 'not-allowed');
            } else {
              $('#select-menu-purchase-button').prop('disabled', false);
              $('#select-menu-purchase-button').css('cursor', 'pointer');

              // If not disabled, update total value when clicked:
              $('#select-menu-purchase-button').click(function() {
                hideSelectMenu();
                $('#image' + item_pos).remove();
                $('#giftTag' + item_pos).remove();
                isOpen[item_pos] = true;
                deductFromTotal(parseFloat(amountInput));
              });
            }

            // Remove this item when clicked:
            $('#select-menu-remove-button').click(function() {
              hideSelectMenu();
              $('#image' + item_pos).remove();
              $('#giftTag' + item_pos).remove();
              isOpen[item_pos] = true;
            });

            /* TODO: Add click listener for Edit button */
          });

          modal.style.display = "none"; // get rid of the modal after clickin confirm

          $("#add-modal-name-input").val(""); // clear input boxes
          $("#add-modal-amount-input").val("");
          disableConfirmButton();
        }

        var imageLoader = document.getElementById('add-modal-icon-loader');
        imageLoader.addEventListener('change', handleImage, false);
        imageCanvas.addEventListener('click', clickIcon, false);

        /*
         * Listener function: this function is called anytime the user clicks on either
         * the thought bubble, the first column area, the last column area, and the 'x'
         * button on the select menu.
         */
        function hideSelectMenu() {
          $('#select-menu-detail').hide();
          // Detach select menu button listeners:
          $('#select-menu-purchase-button').off('click');
          $('#select-menu-remove-button').off('click');
        }

        /*
         * Helper function: determine whether a given value is numeric or not.
         * A value is numeric if it is not NaN and if the value is finite.
         */
        function isNumeric(value) {
          return !isNaN(parseFloat(value)) && isFinite(value);
        }

        /*
         * Listener function: any time a user changes the name input field or the amount
         * input field, this funciton is called to toggle the 'disable' attribute for the
         * confirm button. Ensures that the amount value is numeric and non-negative.
         */
        function checkValidAddInputs() {

          // Check name input:
          var nameValue = document.getElementById('add-modal-name-input').value;
          if (nameValue == null || nameValue == '') {
            /* TODO: show error message 'please enter name' */
            disableConfirmButton();
            return;
          }

          // Check amount input:
          var amountValue = document.getElementById('add-modal-amount-input').value;
          if (amountValue == null || amountValue == '' || !isNumeric(amountValue) || amountValue < 0.00) {
            /* TODO: show error message 'please enter valid amount value' */
            disableConfirmButton();
            return;
          }

          // Otherwise, all good:
          enableConfirmButton();
        }

        function disableConfirmButton() {
          $('#add-modal-confirm-button').prop('disabled', true);
          $('#add-modal-confirm-button').css('cursor', 'not-allowed');
          $('#add-modal-confirm-button').css('background-color', 'gray');
        }

        function enableConfirmButton() {
          $('#add-modal-confirm-button').prop('disabled', false);
          $('#add-modal-confirm-button').css('cursor', 'pointer');
          $('#add-modal-confirm-button').css('background-color', 'pink');
        }
        
    </script>

</html>